version: v1.0
name: go-build
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 30

global_job_config:
  secrets:
    - name: docker-hub
  prologue:
    commands:
      # This login uses the basic credentials for pulling images.  The jobs that need to push will use the
      # push-enabled secret below.
      - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
      - >
        if [ $SEMAPHORE_GIT_REF_TYPE = "tag" ]; then
          export BRANCH_NAME=$SEMAPHORE_GIT_TAG_NAME;
        else
          export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH;
        fi;
      - export VERSION=$BRANCH_NAME
      - checkout
      # Semaphore is doing shallow clone on a commit without tags.
      # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
      - git fetch --unshallow

blocks:
# Run the full set of tests. Each job can potentially be run in parallel,
# provided Semaphore has enough boxes available.
- name: "Tests"
  dependencies: []
# TODO re enable this when semaphore has provided an explanation as to why it's timing out.
#  run:
#    when: "change_in('/Makefile.common') or change_in('/.semaphore/')"
  task:
    jobs:
    - name: "Build downstream projects with our Makefile.common"
      commands:
      - git clone git@github.com:projectcalico/$REPO.git $REPO
      - cd $REPO
      - make Makefile.common
      - cp ../Makefile.common ./
      - make ut
      matrix:
      - env_var: REPO
        values: ["felix", "calicoctl", "libcalico-go"]

- name: "Build images"
  dependencies: []
  task:
    secrets:
    - name: quay-robot-calico-and-semaphoreci
    - name: docker
    jobs:
    - name: Build and push image
      commands:
      - echo $DOCKER_TOKEN | docker login --username "$DOCKER_USER" --password-stdin
      - echo $QUAY_TOKEN | docker login --username "$QUAY_USER" --password-stdin quay.io
      - make image ARCH=$ARCH
      - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make push ARCH=$ARCH CONFIRM=true; fi
      matrix:
      - env_var: ARCH
        values: ["amd64", "arm64","armv7", "ppc64le"]

- name: "Push manifest"
  skip:
    # Only run on branches, not PRs.
    when: "branch !~ '.+' AND tag !~ '.*'"
  dependencies: ["Build images"]
  task:
    secrets:
    - name: quay-robot-calico-and-semaphoreci
    - name: docker
    jobs:
    - name: Push multi-arch manifest
      commands:
      - echo $DOCKER_TOKEN | docker login --username "$DOCKER_USER" --password-stdin
      - echo $QUAY_TOKEN | docker login --username "$QUAY_USER" --password-stdin quay.io
      - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make push-manifest CONFIRM=true; fi

